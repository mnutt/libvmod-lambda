varnishtest "Test lambda vmod basic loading"

server s1 {
    rxreq
    txresp
} -start

varnish v1 -vcl+backend {
    import lambda from "${vmod}";

    sub vcl_init {
        new my_lambda = lambda.backend(
            function_name="test-function",
            region="us-east-1",
            pool_size=1
        );
    }

    sub vcl_deliver {
        set resp.http.function-name = my_lambda.get_function_name();
        set resp.http.region = my_lambda.get_region();
    }
} -start

client c1 {
    txreq
    rxresp
    expect resp.http.function-name == "test-function"
    expect resp.http.region == "us-east-1"
} -run
