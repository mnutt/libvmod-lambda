varnishtest "Test lambda backend health probe failure handling"

# Mock Lambda endpoint that starts healthy then fails
server s1 {
    # First probe - healthy
    rxreq
    txresp -status 200 -body {{"statusCode": 200, "body": "{\"health\": \"ok\"}"}}

    # Backend request while healthy
    rxreq
    expect req.url == "/2015-03-31/functions/probe-test/invocations"
    txresp -status 200 \
        -hdr "Content-Type: application/json" \
        -body {{"statusCode": 200, "body": "{\"message\": \"Success\"}"}}

    rxreq
    txresp -status 500 -body "Internal error"
} -start

varnish v1 -vcl {
    import lambda from "${vmod}";

    backend default none;

    probe lambda_probe {
        .url = "/health";
        .interval = 1s;
        .timeout = 1s;
        .window = 2;
        .threshold = 2;
        .initial = 1;
    }

    sub vcl_init {
        new my_lambda = lambda.backend(
            function_name="probe-test",
            region="us-east-1",
            endpoint_url="http://${s1_addr}:${s1_port}",
            probe=lambda_probe,
            pool_size=1
        );
    }

    sub vcl_recv {
        return (pass);
    }

    sub vcl_backend_fetch {
        set bereq.backend = my_lambda.backend();
    }

    sub vcl_backend_error {
        # Handle backend errors gracefully
        set beresp.status = 503;
        set beresp.reason = "Backend unhealthy";
        return (deliver);
    }
} -start

# Wait for initial probe to establish health (probe at t=0)
delay 0.5

# First request should succeed (backend is healthy)
client c1 {
    txreq -url "/test1"
    rxresp
    expect resp.status == 200
    expect resp.body ~ "Success"
} -run

# Wait for second probe to fail (at t=~2s)
# After that 500 error, backend is unhealthy (1 good out of 2 < threshold of 2)
delay 1.7

# Second request should fail with 503 (backend is unhealthy)
client c2 {
    txreq -url "/test2"
    rxresp
    expect resp.status == 503
    expect resp.reason == "Backend unhealthy"
} -run

# Display backend status (informational only, non-asserting)
shell {
    varnishadm -n ${v1_name} backend.list -p
}
