varnishtest "Test lambda backend with raw HTTP response mode (raw_response_mode=true)"

# Mock Lambda endpoint that returns a raw HTTP response
server s1 {
    rxreq
    expect req.url == "/2015-03-31/functions/raw-response-test/invocations"
    expect req.method == "POST"
    expect req.http.X-Amz-Invocation-Type == "RequestResponse"

    # Return Lambda response with raw HTTP payload
    # The body contains the actual raw HTTP response
    txresp -status 200 \
        -hdr "Content-Type: text/plain" \
        -hdr "x-amzn-RequestId: test-request-id" \
        -body "HTTP/1.1 201 Created\r\nX-Custom-Header: custom-value\r\nContent-Type: application/json\r\n\r\n{\"message\":\"resource created\"}"

    # Second request: binary data with invalid UTF-8 in body
    # The response body itself contains raw HTTP with binary data
    rxreq
    expect req.url == "/2015-03-31/functions/raw-response-test/invocations"
    txresp -status 200 \
        -hdr "Content-Type: application/octet-stream" \
        -hdr "x-amzn-RequestId: test-request-id-2" \
        -bodyfrom "${testdir}/binary_response.bin"
} -start

varnish v1 -vcl {
    import lambda from "${vmod}";

    backend default none;

    sub vcl_init {
        new my_lambda = lambda.backend(
            function_name="raw-response-test",
            region="us-east-1",
            endpoint_url="http://${s1_addr}:${s1_port}",
            raw_response_mode=true
        );
    }

    sub vcl_recv {
        return (pass);
    }

    sub vcl_backend_fetch {
        set bereq.backend = my_lambda.backend();
    }
} -start

client c1 {
    txreq -url "/api/create" \
        -hdr "Host: example.com"
    rxresp
    expect resp.status == 201
    expect resp.http.X-Custom-Header == "custom-value"
    expect resp.http.Content-Type == "application/json"
    expect resp.body == {{"message":"resource created"}}
} -run

# Test binary response with non-UTF-8 data in body
# This validates that the fix allows binary data in response bodies
client c2 {
    txreq -url "/api/binary" \
        -hdr "Host: example.com"
    rxresp
    expect resp.status == 200
    expect resp.http.Content-Type == "application/octet-stream"
    expect resp.http.Content-Length == "10"
    expect resp.bodylen == 10
} -run
