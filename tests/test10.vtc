varnishtest "Test lambda backend VSC metrics"

# Mock Lambda endpoint
server s1 {
    # First request - success
    rxreq
    expect req.url == "/2015-03-31/functions/test-vsc/invocations"
    txresp -status 200 \
        -hdr "Content-Type: application/json" \
        -body {{"statusCode": 200, "headers": {"X-Test": "value"}, "body": "test response"}}

    # Second request - function error
    rxreq
    expect req.url == "/2015-03-31/functions/test-vsc/invocations"
    txresp -status 200 \
        -hdr "Content-Type: application/json" \
        -body {{"statusCode": 500, "body": "Internal Error"}}
} -start

varnish v1 -vcl {
    import lambda from "${vmod}";
    import std;

    backend default none;

    sub vcl_init {
        new my_lambda = lambda.backend(
            function_name="test-vsc",
            region="us-west-2",
            endpoint_url="http://${s1_addr}:${s1_port}",
            pool_size=1
        );
    }

    sub vcl_recv {
        set req.backend_hint = my_lambda.backend();
        return (pass);
    }
} -start

# Make first request
client c1 {
    txreq -url "/test" -hdr "Host: example.com"
    rxresp
    expect resp.status == 200
    expect resp.body == "test response"
} -run

# Make second request (function error)
client c2 {
    txreq -url "/test2" -hdr "Host: example.com"
    rxresp
    expect resp.status == 500
} -run

# Check VSC metrics
varnish v1 -expect lambda.my_lambda.req == 2
varnish v1 -expect lambda.my_lambda.function_error == 0
varnish v1 -expect lambda.my_lambda.bereq_hdrbytes > 0
varnish v1 -expect lambda.my_lambda.beresp_bodybytes > 0
